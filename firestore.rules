rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // User profile - only authenticated users can access their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // User data - only authenticated users can access their own data
    match /users/{userId}/data/{document} {
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Progress data validation
      allow write: if request.auth != null 
        && request.auth.uid == userId
        && (document != 'progress' || (
          request.resource.data.attempts is list
          && request.resource.data.totalCredits is number
          && request.resource.data.totalPoints is number
          && request.resource.data.totalPoints >= 0
          && request.resource.data.currentStreak is number
          && request.resource.data.currentStreak >= 0
        ))
        // Achievements data validation
        && (document != 'achievements' || (
          request.resource.data.userId == userId
          && request.resource.data.unlockedAchievements is list
          && request.resource.data.progress is map
        ))
        // Rewards data validation
        && (document != 'rewards' || (
          request.resource.data.themes is list
          && request.resource.data.hints is number
          && request.resource.data.hints >= 0
          && request.resource.data.avatarFrames is list
        ))
        // Favorites data validation
        && (document != 'favorites' || (
          request.resource.data.favorites is list
        ));
    }
    
    // Custom exercises - only authenticated users can access their own exercises
    match /users/{userId}/customExercises/{exerciseId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      
      allow create: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && request.resource.data.title is string
        && request.resource.data.title.size() >= 3
        && request.resource.data.title.size() <= 100
        && request.resource.data.sourceText is string
        && request.resource.data.sourceText.size() >= 10
        && request.resource.data.highlightedSentences is list
        && request.resource.data.highlightedSentences.size() >= 1
        && request.resource.data.isCustom == true;
      
      allow update: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && request.resource.data.title is string
        && request.resource.data.title.size() >= 3
        && request.resource.data.title.size() <= 100
        && request.resource.data.sourceText is string
        && request.resource.data.sourceText.size() >= 10
        && request.resource.data.highlightedSentences is list
        && request.resource.data.highlightedSentences.size() >= 1;
      
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
