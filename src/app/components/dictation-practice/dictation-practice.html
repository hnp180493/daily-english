<div class="dictation-practice-container min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
  <div class="max-w-4xl mx-auto px-4">
    <!-- Loading State -->
    @if (isLoading()) {
      <div class="text-center py-12" role="status" aria-live="polite">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto"
          aria-hidden="true"
        ></div>
        <p class="mt-4 text-gray-600 dark:text-gray-400">Loading dictation practice...</p>
      </div>
    }

    <!-- Error State -->
    @if (error() && !isLoading()) {
      <div
        class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-6 text-center"
        role="alert"
        aria-live="assertive"
      >
        <div class="text-red-600 dark:text-red-400 text-lg font-semibold mb-2">
          {{ error() }}
        </div>
        @if (
          error() === 'No translation available. Please complete the translation exercise first.'
        ) {
          <p class="text-gray-600 dark:text-gray-400 mt-2 mb-4">
            You can practice dictation using the provided English text, or complete the translation
            exercise first to practice with your own translation.
          </p>
        }
        <button
          (click)="goBack()"
          class="mt-4 px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition"
          aria-label="Go back to exercise"
        >
          Go Back
        </button>
      </div>
    }

    <!-- Main Content -->
    @if (!isLoading() && !error()) {
      <!-- Header -->
      <app-dictation-header
        [exercise]="exercise()"
        [progressPercentage]="progressPercentage()"
        [currentSentenceIndex]="currentSentenceIndex()"
        [totalSentences]="sentences().length"
        [attemptCount]="attemptCount()"
        [completionPoints]="DICTATION_COMPLETION_POINTS"
        (settingsClick)="openSettings()"
        (goBack)="goBack()"
      ></app-dictation-header>

      <!-- Completion Screen -->
      @if (isComplete()) {
        <app-dictation-completion
          [overallAccuracy]="overallAccuracy()"
          [completedCount]="completedSentencesCount()"
          [totalSentences]="sentences().length"
          [completionPoints]="DICTATION_COMPLETION_POINTS"
          (retry)="retry()"
          (goBack)="goBack()"
        ></app-dictation-completion>
      }

      <!-- Practice Interface -->
      @if (!isComplete()) {
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
          <!-- Audio Controls -->
          <app-dictation-audio-controls
            [currentSentence]="currentSentence()"
            [canGoPrevious]="canGoPrevious()"
            [canGoNext]="canGoNext()"
            [currentSentenceIndex]="currentSentenceIndex()"
            [totalSentences]="sentences().length"
            (previous)="previousSentence()"
            (next)="nextSentence()"
            (playingChange)="isPlaying.set($event)"
            (pausedChange)="isPaused.set($event)"
            (speedChange)="playbackSpeed.set($event)"
          ></app-dictation-audio-controls>

          <!-- Sentence Counter -->
          <div class="text-center mb-4" role="status" aria-live="polite">
            <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              Sentence {{ currentSentenceIndex() + 1 }} of {{ sentences().length }}
            </span>
          </div>

          <!-- Input Area -->
          <app-dictation-input
            [userInput]="userInput()"
            [showFeedback]="showFeedback()"
            [currentAccuracy]="currentAccuracy()"
            [currentSentence]="currentSentence()"
            [passingScore]="PASSING_SCORE"
            (userInputChange)="userInput.set($event)"
            (enterKey)="submitAnswer()"
          ></app-dictation-input>

          <!-- Action Buttons -->
          <app-dictation-actions
            [showFeedback]="showFeedback()"
            [currentAccuracy]="currentAccuracy()"
            [userInput]="userInput()"
            [passingScore]="PASSING_SCORE"
            [canGoNext]="canGoNext()"
            [autoNextOnPerfect]="settings().autoNextOnPerfect"
            [isSubmitting]="isSubmitting()"
            (submit)="submitAnswer()"
            (replay)="onReplayAudio()"
            (retry)="retryAnswer()"
            (skip)="skipSentence()"
            (next)="nextSentence()"
            (complete)="completeSession()"
          ></app-dictation-actions>

          <!-- Feedback Display -->
          @if (showFeedback() && currentSentence() && currentSentence()!.feedback) {
            <!-- Only show feedback if not auto-advancing or if score is below passing -->
            @if (!settings().autoNextOnPerfect || currentAccuracy() < PASSING_SCORE) {
              <app-dictation-feedback
                [feedback]="currentSentence()!.feedback"
                [originalText]="currentSentence()!.original"
                [userText]="currentSentence()!.userInput"
                [showAnswer]="currentAccuracy() >= PASSING_SCORE || settings().showAnswerWhenWrong"
              >
              </app-dictation-feedback>
            }
          }
        </div>

        <!-- Shortcut Tips -->
        <app-dictation-shortcuts
          [showShortcutTips]="settings().showShortcutTips"
          [playPauseKey]="settings().playPauseKey"
          [replayKey]="settings().replayKey"
        ></app-dictation-shortcuts>

        <!-- Overview Section -->
        <app-dictation-overview
          [sentences]="sentences()"
          (overviewToggled)="showOverview.set($event)"
        ></app-dictation-overview>
      }
    }
  </div>

  <!-- Settings Modal -->
  @if (showSettings()) {
    <app-dictation-settings (close)="closeSettings()"></app-dictation-settings>
  }
</div>
