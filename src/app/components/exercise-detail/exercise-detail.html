@if (showApiKeyPrompt()) {
  <app-api-key-prompt
    (close)="onCloseApiKeyPrompt()"
    (goToSettings)="onGoToSettings()">
  </app-api-key-prompt>
}

@if (isLoadingExercise()) {
  <app-loading-spinner [fullscreen]="true" [message]="'ƒêang t·∫£i b√†i t·∫≠p...'" />
} @else if (exercise()) {
  <div class="exercise-detail-container">
    <!-- Header with Title, Stats and Progress Bar -->
    <header class="exercise-header">
      <div class="header-left">
        <button class="back-btn" (click)="onQuit()" aria-label="Back to exercises">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </button>
        <h1 class="exercise-title">
          {{ exercise()!.title }}
          @if (isCustomExercise()) {
            <span class="custom-badge">Custom</span>
          }
        </h1>
        <button 
          class="favorite-btn-detail" 
          (click)="toggleFavorite()"
          [class.is-favorite]="isFavorite()"
          [attr.aria-label]="isFavorite() ? 'X√≥a kh·ªèi y√™u th√≠ch' : 'Th√™m v√†o y√™u th√≠ch'">
          <svg class="w-6 h-6" viewBox="0 0 24 24">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
          </svg>
        </button>
        <button 
          class="dictation-btn" 
          (click)="onPracticeDictationOriginal()"
          aria-label="Practice dictation with original text">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
            <line x1="12" y1="19" x2="12" y2="23"/>
            <line x1="8" y1="23" x2="16" y2="23"/>
          </svg>
          <span class="dictation-btn-text">Dictation</span>
        </button>
      </div>
      <div class="header-stats">
        <!-- <span class="stat-item">üí∞ {{ creditsToEarn() }} credits</span> -->
        <span class="stat-item">‚≠ê {{ exercisePoints() }} points</span>
        @if (perfectCompletions() > 0) {
          <span class="stat-item mastered-badge">
            üèÜ {{ perfectCompletions() }}√ó Perfect
          </span>
        }
        <span class="progress-text">Progress: {{ currentSentenceIndex() }}/{{ sentences().length }} sentences</span>
      </div>
    </header>

    <div class="progress-bar-container">
      <div class="progress-bar-fill" [style.width.%]="progressPercentage()"></div>
    </div>

    <!-- Main Content: 2 Column Layout -->
    <div class="exercise-content">
        <!-- Left Column: Full Text + Input Area -->
        <div class="left-column">
          <!-- Full Original Text -->
          <div class="section-card original-text-card">
            <div class="full-text-box">
              <p class="full-text">
                @for (sentence of sentences(); track sentence.original; let i = $index) {
                  <span
                    [class.sentence-completed]="sentence.isCompleted"
                    [class.sentence-current]="i === currentSentenceIndex()"
                    [class.sentence-pending]="i > currentSentenceIndex()">
                    {{ sentence.showTranslation ? sentence.translation : sentence.original }}{{ i < sentences().length - 1 ? ' ' : '' }}
                  </span>
                }
              </p>
            </div>
            @if (completedSentences().length > 0) {
              <div class="flex items-center gap-3">
                <button 
                  class="inline-paragraph-tts-btn" 
                  (click)="toggleFullTextTTS()"
                  [class.playing]="isPlayingTTS()"
                  [attr.aria-label]="isPlayingTTS() ? 'Pause reading' : 'Play full text'">
                  @if (isPlayingTTS() && !isPausedTTS()) {
                    ‚è∏Ô∏è
                  } @else {
                    üîä
                  }
                </button>
                <app-tts-settings />
              </div>
            }
          </div>

          <!-- Translation Input Area -->
          @if (!isReviewMode() && !isExerciseComplete()) {
            <div class="translation-input-section">
              <textarea 
                #translationInput
                class="translation-textarea"
                [ngModel]="userInput()"
                (ngModelChange)="userInput.set($event); onInputChange()"
                [disabled]="isSubmitting() || hasThreeConsecutiveFailures()"
                [readonly]="canProceedToNext()"
                placeholder="Enter your English translation here... (Only highlighted sentence)"
                rows="3"></textarea>

              <!-- Action Buttons -->
              <div class="actions">
                @if (!canProceedToNext() && !hasThreeConsecutiveFailures()) {
                  <div class="action-buttons-row">
                    <button 
                      class="action-btn submit-btn" 
                      (click)="onSubmit()" 
                      [disabled]="!userInput() || isSubmitting()">
                      @if (!isSubmitting()) {
                        <span>Submit</span>
                      } @else {
                        <span>Analyzing...</span>
                      }
                    </button>
                    <button 
                      class="action-btn hint-btn" 
                      (click)="onHint()" 
                      [disabled]="!hasMoreHints() || isLoadingHint()">
                      @if (isLoadingHint()) {
                        <span>‚è≥ Loading...</span>
                      } @else {
                        <span>üí° Hint ({{ hintsShown() }}/3)</span>
                      }
                    </button>
                  </div>
                } @else if (hasThreeConsecutiveFailures()) {
                  <div class="failure-message">
                    <p>You've tried 3 times. Would you like to move to the next sentence or try again?</p>
                  </div>
                  <div class="action-buttons-row">
                    <button 
                      class="action-btn next-btn" 
                      (click)="onSkipToNextSentence()">
                      Next Sentence ‚Üí
                    </button>
                    <button 
                      class="action-btn retry-btn" 
                      (click)="onRetrySentence()"
                      aria-label="Retry this sentence">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                      </svg>
                      Retry
                    </button>
                  </div>
                } @else {
                  <div class="action-buttons-row">
                    <button 
                      class="action-btn next-btn" 
                      (click)="onNextSentence()">
                      Next Sentence ‚Üí
                    </button>
                    <button 
                      class="action-btn retry-btn" 
                      (click)="onRetrySentence()"
                      aria-label="Retry this sentence">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                      </svg>
                      Retry
                    </button>
                  </div>
                }
              </div>
            </div>
          }
          
          <!-- Review Mode: Show all completed sentences -->
          @if (isReviewMode() || isExerciseComplete()) {
            <app-translation-review
              [sentences]="sentences()"
              [currentSentenceIndex]="currentSentenceIndex()"
              [currentTTSSentenceIndex]="currentTTSSentenceIndex()"
              [isExerciseComplete]="isExerciseComplete()"
              (practiceAgain)="onPracticeAgain()"
              (practiceDictation)="onPracticeDictation()"
              (quit)="onQuit()"
              (playSentence)="playSentence($event)">
            </app-translation-review>
          }
        </div>

        <!-- Right Column: Dictionary, Feedback, Achievements -->
        <div class="right-column">
          <!-- Dictionary -->
          @if(!isReviewMode()) {
            <div class="section-card dictionary-card">
              <!-- <h3 class="section-title">üìö Dictionary</h3> -->
              <div class="dictionary-content">
                @if (isStreaming()) {
                  <div class="streaming-indicator">
                    <div class="streaming-dots">
                      <span class="dot"></span>
                      <span class="dot"></span>
                      <span class="dot"></span>
                    </div>
                    <p class="streaming-text">Analyzing your translation...</p>
                  </div>
                } @else if (accuracyScore()) {
                  <div class="accuracy-badge">
                    <span class="accuracy-icon">‚úì</span>
                    <span class="accuracy-text">{{ accuracyScore() }}% Accuracy</span>
                  </div>
                } @else {
                  <div class="dictionary-placeholder">
                    <p class="placeholder-text">Type your answer and hit Submit to check your result!</p>
                  </div>
                }
              </div>
            </div>
          }

          <!-- Penalty Score Display -->
          <app-penalty-score
            [penaltyMetrics]="penaltyMetrics()"
            [currentMetrics]="currentPenaltyMetrics()"
            [isReviewMode]="isReviewMode()"
            [isExerciseComplete]="isExerciseComplete()">
          </app-penalty-score>

          <!-- Feedback Panel -->
          @if (feedback()) {
            <div class="section-card feedback-card">
              <h3 class="section-title">Feedback</h3>
              <app-feedback-panel
                [userInput]="userInputAfterSubmit()"
                [feedback]="feedback()!"
                [accuracyScore]="accuracyScore()">
              </app-feedback-panel>
            </div>
          }

          <!-- Hint -->
          @if (currentHint()) {
            <div class="section-card hint-card">
              <h3 class="section-title">üí° Hint</h3>
              <p class="hint-text">{{ currentHint() }}</p>
            </div>
          }

          <!-- Today's Achievements -->
          <!-- <div class="section-card achievements-card">
            <h3 class="section-title">Today's Achievements</h3>
            <app-progress-stats
              [streak]="streak()"
              [achievements]="achievements()">
            </app-progress-stats>
          </div> -->
        </div>
      </div>
  </div>
}

<!-- API Key Prompt Modal -->
@if (showApiKeyPrompt()) {
  <app-api-key-prompt
    (close)="onCloseApiKeyPrompt()"
    (goToSettings)="onGoToSettings()">
  </app-api-key-prompt>
}

<!-- Error Modal -->
@if (showErrorModal()) {
  <app-error-modal
    [errorMessage]="errorMessage()"
    (close)="onCloseErrorModal()">
  </app-error-modal>
}
