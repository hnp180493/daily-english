<div class="performance-section">
  <h2>Performance Analysis</h2>

  <!-- Exercises Needing Review -->
  <div class="analysis-card">
    <div class="card-header">
      <h3>Exercises Needing Review</h3>
      @if (analytics().exercisesNeedingReview && analytics().exercisesNeedingReview.length > 0) {
        <span class="count-badge">{{ analytics().exercisesNeedingReview.length }}</span>
      }
    </div>
    @if (analytics().exercisesNeedingReview && analytics().exercisesNeedingReview.length > 0) {
      <div class="review-grid">
        @for (exercise of analytics().exercisesNeedingReview; track exercise.exerciseId) {
          <div class="review-card" [class]="getAccuracyClass(exercise.score)">
            <div class="review-header">
              <div class="exercise-info">
                <span class="exercise-id">{{ exercise.exerciseId }}</span>
                <span class="attempt-badge">
                  <svg class="icon" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                    <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                  </svg>
                  {{ exercise.attemptCount }} attempt{{ exercise.attemptCount > 1 ? 's' : '' }}
                </span>
              </div>
              <div class="score-display" [class]="getAccuracyClass(exercise.score)">
                <span class="score-value">{{ exercise.score }}%</span>
                <span class="score-label">Score</span>
              </div>
            </div>
            <button class="review-btn" (click)="goToExercise(exercise.exerciseId)">
              <svg class="btn-icon" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/>
              </svg>
              Review Now
            </button>
          </div>
        }
      </div>
    } @else {
      <div class="success-state">
        <div class="success-icon">ðŸŽ‰</div>
        <p class="success-message">Great job! No exercises need immediate review</p>
        <p class="success-submessage">Keep up the excellent work!</p>
      </div>
    }
  </div>

  <!-- Category Accuracy -->
  <div class="analysis-card">
    <h3>Accuracy by Category</h3>
    @if (analytics().categoryAccuracy.length > 0) {
      <div class="table-container">
        <table class="accuracy-table" role="table" [attr.aria-label]="'Category accuracy statistics'">
          <thead>
            <tr>
              <th>Category</th>
              <th>Exercises</th>
              <th>Avg Score</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            @for (cat of analytics().categoryAccuracy; track cat.category) {
              <tr [class]="getAccuracyClass(cat.avgScore)">
                <td>{{ cat.categoryName }}</td>
                <td>{{ cat.exerciseCount }}</td>
                <td>{{ cat.avgScore }}%</td>
                <td>
                  <span class="status-badge" [class]="getAccuracyClass(cat.avgScore)">
                    {{ getPerformanceLabel(cat.avgScore) }}
                  </span>
                  @if (cat.exerciseCount === 1) {
                    <span class="limited-data-badge">Limited data</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    } @else {
      <p class="empty-message">No category data available yet</p>
    }
  </div>

  <!-- Difficulty Comparison -->
  <div class="analysis-card">
    <h3>Performance by Difficulty</h3>
    @if (analytics().difficultyComparison.length > 0) {
      <div class="comparison-grid">
        @for (diff of analytics().difficultyComparison; track diff.level) {
          <div class="difficulty-card" [class.recommended]="diff.readyToAdvance" [class.current]="diff.isCurrentLevel">
            <h4>{{ diff.levelName }}</h4>
            <div class="stat">
              <label>Average Score</label>
              <span class="value">{{ diff.avgScore }}%</span>
            </div>
            <div class="stat">
              <label>Exercises Completed</label>
              <span class="value">{{ diff.exerciseCount }}</span>
            </div>
            <div class="stat">
              <label>Completion Rate</label>
              <span class="value">{{ diff.completionRate }}%</span>
            </div>
            @if (diff.readyToAdvance) {
              <div class="advancement-notice">
                <span class="icon">ðŸŽ“</span>
                <p>Ready for next level!</p>
              </div>
            }
            @if (diff.isCurrentLevel) {
              <div class="progress-indicator">
                <label>Progress to advancement</label>
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="diff.advancementProgress"></div>
                </div>
                <span class="progress-text">{{ diff.advancementProgress }}%</span>
              </div>
            }
          </div>
        }
      </div>
    } @else {
      <p class="empty-message">No difficulty data available yet</p>
    }
  </div>
</div>
