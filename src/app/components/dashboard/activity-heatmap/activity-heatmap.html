<div class="heatmap-section">
  <h2>Activity Heatmap</h2>

  <div class="streak-stats">
    <div class="stat-card">
      <span class="icon">üî•</span>
      <div>
        <label>Current Streak</label>
        <strong>{{ analytics().currentStreak }} days</strong>
      </div>
    </div>
    <div class="stat-card">
      <span class="icon">üèÜ</span>
      <div>
        <label>Longest Streak</label>
        <strong>{{ analytics().longestStreak }} days</strong>
      </div>
    </div>
  </div>

  <div class="heatmap-container">
    @if (analytics().heatmapData.length > 0) {
      <div class="heatmap-grid">
        @for (week of analytics().heatmapData; track week.weekNumber) {
          <div class="heatmap-week">
            @for (day of week.days; track day.date) {
              <div 
                class="heatmap-cell"
                [class.intensity-0]="day.intensity === 0"
                [class.intensity-1]="day.intensity === 1"
                [class.intensity-2]="day.intensity === 2"
                [class.intensity-3]="day.intensity === 3"
                [class.intensity-4]="day.intensity === 4"
                [class.selected]="selectedDay()?.date === day.date"
                [title]="getTooltip(day)"
                [attr.aria-label]="getTooltip(day)"
                (click)="showDayDetails(day)"
                (keydown.enter)="showDayDetails(day)"
                (keydown.space)="showDayDetails(day)"
                tabindex="0"
                role="button">
              </div>
            }
          </div>
        }
      </div>
      
      <div class="heatmap-legend">
        <span>Less</span>
        <div class="legend-cell intensity-0"></div>
        <div class="legend-cell intensity-1"></div>
        <div class="legend-cell intensity-2"></div>
        <div class="legend-cell intensity-3"></div>
        <div class="legend-cell intensity-4"></div>
        <span>More</span>
      </div>
    } @else {
      <p class="empty-message">No activity data available yet</p>
    }
  </div>

  <!-- Day Details Panel -->
  @if (selectedDay()) {
    <div class="day-details-overlay" (click)="closeDetails()">
      <div class="day-details-panel" (click)="$event.stopPropagation()" role="dialog" aria-labelledby="day-details-title">
        <div class="panel-header">
          <h3 id="day-details-title">{{ selectedDay()!.formattedDate }}</h3>
          <button 
            class="close-btn" 
            (click)="closeDetails()"
            aria-label="Close details">
            ‚úï
          </button>
        </div>

        <div class="panel-content">
          @if (selectedDay()!.exerciseCount > 0) {
            <div class="day-summary">
              <div class="summary-stat">
                <span class="stat-label">Exercises Completed</span>
                <span class="stat-value">{{ selectedDay()!.exerciseCount }}</span>
              </div>
              <div class="summary-stat">
                <span class="stat-label">Average Score</span>
                <span class="stat-value">{{ selectedDay()!.averageScore }}%</span>
              </div>
            </div>

            <div class="exercise-list">
              <h4>Exercises</h4>
              @for (exercise of selectedDay()!.exercises; track exercise.id) {
                <div class="exercise-item" (click)="goToExercise(exercise.id)">
                  <div class="exercise-info">
                    <span class="exercise-id">{{ exercise.id }}</span>
                    <span class="exercise-time">{{ exercise.timestamp | date:'shortTime' }}</span>
                  </div>
                  <div class="exercise-score" 
                    [class.score-high]="exercise.score >= 80"
                    [class.score-medium]="exercise.score >= 60 && exercise.score < 80"
                    [class.score-low]="exercise.score < 60">
                    {{ exercise.score }}%
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-day">
              <p>üî• Streak day - Keep up the momentum!</p>
              <p class="hint">Activity recorded but no detailed data available</p>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
